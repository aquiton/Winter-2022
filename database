-- PLh20.sql
-- author: Brayden Lane
-- -----------------------------------------------------------------
SET SERVEROUTPUT ON 
SET VERIFY OFF
-- ----------------------------------
ACCEPT rateDecrement NUMBER PROMPT 'Enter the rate decrement: '
ACCEPT allowedMinRate NUMBER PROMPT 'Enter the allowed min. rate: '
DECLARE
bo     boats%ROWTYPE;
   CURSOR sCursor IS
          SELECT B.*
          FROM   reservations R, boats B
          WHERE  B.bid != R.bid
          ORDER BY B.bid;
--
BEGIN
   OPEN sCursor;
      -- Fetch the qualifying rows one by one
      FETCH sCursor INTO bo;
      EXIT WHEN sCursor%NOTFOUND;
      -- Print the sailor' old record
      DBMS_OUTPUT.PUT_LINE ('+++++ Boat: '||bo.bid||' : old rate = '
             ||bo.rate); 
   bo.rate := bo.rate - &ratingDec;

      -- A nested block
      DECLARE 
         belowAllowedMin EXCEPTION;
      BEGIN  
         IF  bo.rate < &allowedMinRating 
         THEN RAISE belowAllowedMin;
         ELSE UPDATE boats
              SET rate =bo.rate
              WHERE sailors.bid =bo.bid;
              -- Print the sailor' new record
      DBMS_OUTPUT.PUT_LINE ('+++++ Boat: '||bo.bid||' : old rate = '
             ||bo.rate); 
         END IF;

      EXCEPTION
        WHEN belowAllowedMin THEN
           DBMS_OUTPUT.PUT_LINE('+++++ Update rejected: '||
 			'The new rate would have been: '||bo.rate);
        WHEN OTHERS THEN
           DBMS_OUTPUT.PUT_LINE('+++++ update rejected: ' ||
                                   SQLCODE||'...'||SQLERRM);
      END;
      -- end of the nested block
   COMMIT;
   CLOSE sCursor;
END;
/

UNDEFINE ratingDec
UNDEFINE allowedMinRating